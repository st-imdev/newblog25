<!-- Mermaid integration that avoids conflicts with the notes graph -->
<script>
  // Load Mermaid library after page load to avoid conflicts with D3.js
  document.addEventListener('DOMContentLoaded', function() {
    // Check if there are any mermaid diagrams on the page
    if (document.querySelectorAll('pre.mermaid').length === 0) return;
    
    // Load Mermaid script
    var script = document.createElement('script');
    script.src = "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js";
    script.onload = function() {
      // Initialize Mermaid
      mermaid.initialize({
        startOnLoad: true,
        theme: document.body.classList.contains('theme-dark') ? 'dark' : 'default',
        flowchart: { 
          useMaxWidth: true,
          htmlLabels: true,
          curve: 'basis'
        },
        sequence: {
          diagramMarginX: 50,
          diagramMarginY: 10
        },
        securityLevel: 'loose'
      });
    };
    document.body.appendChild(script);
    
    // Set up observer for theme changes
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.attributeName === 'class' && window.mermaid) {
          const isDarkMode = document.body.classList.contains('theme-dark');
          // Reinitialize with new theme
          window.mermaid.initialize({
            theme: isDarkMode ? 'dark' : 'default'
          });
          
          // Force reload of all diagrams
          window.mermaid.init(undefined, 'pre.mermaid');
        }
      });
    });
    
    observer.observe(document.body, { attributes: true });
  });
</script>

<style>
  pre.mermaid {
    background: var(--color-bg-secondary);
    border-radius: var(--border-radius);
    border: 1px solid var(--color-ui-normal);
    padding: 1rem;
    margin: 2rem 0;
    min-height: 100px;
    text-align: center;
  }
  
  pre.mermaid svg {
    max-width: 100%;
  }
  
  /* Dark mode fixes */
  .theme-dark .mermaid text,
  .theme-dark .mermaid .messageText,
  .theme-dark .mermaid .loopText,
  .theme-dark .mermaid .labelText,
  .theme-dark .mermaid .titleText,
  .theme-dark .mermaid .node rect,
  .theme-dark .mermaid .node circle,
  .theme-dark .mermaid .cluster rect {
    fill: var(--color-tx-normal) !important;
    stroke: var(--color-tx-normal) !important;
  }
  
  .theme-dark .mermaid .edgePath .path,
  .theme-dark .mermaid line,
  .theme-dark .mermaid .loopLine {
    stroke: var(--color-tx-normal) !important;
  }
  
  .theme-dark .mermaid .arrowheadPath {
    fill: var(--color-tx-normal) !important;
    stroke: var(--color-tx-normal) !important;
  }
  
  .theme-dark .mermaid .edgeLabel rect {
    fill: var(--color-bg-secondary) !important;
  }
</style> 