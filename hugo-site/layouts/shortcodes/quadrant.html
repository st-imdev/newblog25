{{ $id := .Get "id" | default (printf "quad-%d" (now.UnixNano)) }}
{{ $x := .Get "xLabel" | default "Certainty" }}
{{ $y := .Get "yLabel" | default "Skin in the Game" }}
{{ $q1 := .Get "q1" | default "High certainty, low skin" }}
{{ $q2 := .Get "q2" | default "High certainty, high skin" }}
{{ $q3 := .Get "q3" | default "Low certainty, high skin" }}
{{ $q4 := .Get "q4" | default "Low certainty, low skin" }}

<div id="{{ $id }}-container" class="quadrant-d3-container" style="width:100%;max-width:700px;margin:3rem auto;min-height:400px;background:#fafafa;border:1px solid #e0e0e0;border-radius:8px;position:relative;">
  <div id="{{ $id }}-loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#999;">Loading quadrant...</div>
</div>

<script>
console.log('ðŸŸ¦ QUADRANT SHORTCODE SCRIPT STARTING for ID: {{ $id }}');

// Create a unique namespace for this quadrant
(function() {
  console.log('ðŸŸ¦ Inside IIFE for quadrant {{ $id }}');
  
  var containerId = "{{ $id }}-container";
  var loadingId = "{{ $id }}-loading";
  
  console.log('ðŸŸ¦ Container ID:', containerId);
  console.log('ðŸŸ¦ Current D3 status:', typeof d3);
  console.log('ðŸŸ¦ Document ready state:', document.readyState);
  
  // Check if container exists
  var containerCheck = document.getElementById(containerId);
  console.log('ðŸŸ¦ Container exists in DOM?', !!containerCheck);
  
  function drawQuadrant() {
    console.log('ðŸŸ© drawQuadrant() called for', containerId);
    console.log('ðŸŸ© D3 available?', typeof d3 !== 'undefined');
    
    if (typeof d3 === 'undefined') {
      console.error('ðŸ”´ D3 is undefined in drawQuadrant!');
      return false;
    }
    
    console.log('ðŸŸ© D3 version:', d3.version);
    
    var container = d3.select('#' + containerId);
    if (container.empty()) {
      console.error('ðŸ”´ Container not found with D3 selector:', containerId);
      return false;
    }
    
    console.log('ðŸŸ© Container found, clearing content...');
    container.html('');
    
    var containerWidth = container.node().getBoundingClientRect().width;
    console.log('ðŸŸ© Container width:', containerWidth);
    
    if (containerWidth === 0) {
      console.error('ðŸ”´ Container has no width, will retry in 500ms...');
      setTimeout(drawQuadrant, 500);
      return false;
    }
    
    try {
      console.log('ðŸŸ© Starting to draw quadrant...');
      
      var isMobile = containerWidth < 500;
      var margin = isMobile 
        ? {top: 30, right: 20, bottom: 50, left: 50}
        : {top: 40, right: 40, bottom: 60, left: 70};
      
      var width = containerWidth - margin.left - margin.right;
      var height = isMobile ? containerWidth * 0.8 : 400;
      var innerHeight = height - margin.top - margin.bottom;
      
      console.log('ðŸŸ© Creating SVG:', containerWidth, 'x', height);
      
      var svg = container.append('svg')
        .attr('width', containerWidth)
        .attr('height', height)
        .style('background', 'white')
        .style('border', '1px solid #ccc');
      
      var g = svg.append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
      
      // Just draw a simple test first
      g.append('text')
        .attr('x', width / 2)
        .attr('y', innerHeight / 2)
        .attr('text-anchor', 'middle')
        .attr('font-size', '24px')
        .attr('fill', 'green')
        .text('QUADRANT RENDERED!');
      
      console.log('âœ… QUADRANT DRAWN SUCCESSFULLY for', containerId);
      return true;
      
    } catch (e) {
      console.error('ðŸ”´ Error drawing quadrant:', e);
      console.error(e.stack);
      return false;
    }
  }
  
  function checkAndLoadD3() {
    console.log('ðŸŸ¨ checkAndLoadD3() called');
    console.log('ðŸŸ¨ typeof d3:', typeof d3);
    console.log('ðŸŸ¨ typeof window.d3:', typeof window.d3);
    
    if (typeof d3 !== 'undefined') {
      console.log('âœ… D3 already available, drawing immediately');
      var success = drawQuadrant();
      if (!success) {
        console.log('ðŸŸ¨ Draw failed, will retry...');
      }
    } else {
      console.log('ðŸŸ¨ D3 not available, need to wait or load it');
      
      // Check if D3 script tag exists
      var d3Scripts = document.querySelectorAll('script[src*="d3"]');
      console.log('ðŸŸ¨ Found D3 script tags:', d3Scripts.length);
      d3Scripts.forEach(function(script) {
        console.log('  - Script src:', script.src);
        console.log('  - Script async:', script.async);
        console.log('  - Script defer:', script.defer);
      });
      
      var attempts = 0;
      var maxAttempts = 20;
      
      var checkInterval = setInterval(function() {
        attempts++;
        console.log('ðŸŸ¨ Checking for D3, attempt', attempts, '- typeof d3:', typeof d3);
        
        if (typeof d3 !== 'undefined') {
          console.log('âœ… D3 loaded after', attempts, 'attempts!');
          clearInterval(checkInterval);
          drawQuadrant();
        } else if (attempts >= maxAttempts) {
          console.error('ðŸ”´ Failed to load D3 after', maxAttempts, 'attempts');
          clearInterval(checkInterval);
          var loadingEl = document.getElementById(loadingId);
          if (loadingEl) {
            loadingEl.innerHTML = 'Failed to load visualization library';
          }
        }
      }, 500);
    }
  }
  
  console.log('ðŸŸ¦ Setting up initialization...');
  
  // Try multiple initialization strategies
  
  // Strategy 1: Direct call with small delay
  setTimeout(function() {
    console.log('ðŸŸ¦ Strategy 1: Direct delayed call');
    checkAndLoadD3();
  }, 100);
  
  // Strategy 2: DOMContentLoaded
  if (document.readyState === 'loading') {
    console.log('ðŸŸ¦ Strategy 2: Waiting for DOMContentLoaded');
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ðŸŸ¦ DOMContentLoaded fired');
      checkAndLoadD3();
    });
  }
  
  // Strategy 3: Window load
  window.addEventListener('load', function() {
    console.log('ðŸŸ¦ Strategy 3: Window load event fired');
    setTimeout(function() {
      if (typeof d3 !== 'undefined' && document.getElementById(containerId)) {
        var container = document.getElementById(containerId);
        if (container && container.innerHTML.includes('Loading')) {
          console.log('ðŸŸ¨ Window load: Container still loading, trying to draw');
          drawQuadrant();
        }
      }
    }, 1000);
  });
  
})();

console.log('ðŸŸ¦ QUADRANT SHORTCODE SCRIPT END for ID: {{ $id }}');
</script>